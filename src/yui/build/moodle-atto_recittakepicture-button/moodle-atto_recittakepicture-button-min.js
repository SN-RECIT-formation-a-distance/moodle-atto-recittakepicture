YUI.add("moodle-atto_recittakepicture-button",function(m,t){IMAGETEMPLATE='<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>',TEMPLATE='<form id="atto_recittakepicture_dialogue" class="recittakepicture"><div class="camera"><video id="{{component}}video"></video></div><div><button id="{{component}}startbutton" class="btn btn-secondary">{{get_string "takephoto" component}}</button></div><canvas id="{{component}}canvas"></canvas><div class="output"><img id="{{component}}photo" alt="capture"></div><button class="btn btn-secondary" id="{{component}}submit" disabled> {{get_string "saveimage" component}}</button></form>',COMPONENTNAME="atto_recittakepicture",m.namespace("M.atto_recittakepicture").Button=m.Base.create("button",m.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,initializer:function(){this.get("host").canShowFilepicker("media")&&this.addButton({title:"takephoto",icon:"e/camera",iconComponent:COMPONENTNAME,callback:this.openCamera,buttonName:"takephoto"})},openCamera:function(){var e,i,o,t,n,a,r,s,d,l,c=this.getDialogue({headerContent:M.util.get_string("pluginname",COMPONENTNAME),width:"auto",focusAfterHide:!0});c.get("boundingBox").setStyle("maxWidth","90%"),t=m.Handlebars.compile(TEMPLATE),t=m.Node.create(t({elementid:this.get("host").get("elementid"),component:COMPONENTNAME})),c.set("bodyContent",t).show(),e=document.getElementById(COMPONENTNAME+"video"),i=document.getElementById(COMPONENTNAME+"canvas"),o=document.getElementById(COMPONENTNAME+"photo"),t=document.getElementById(COMPONENTNAME+"startbutton"),n=document.getElementById(COMPONENTNAME+"submit"),s=!(r=a=200),d="",(l=i.getContext("2d")).fillStyle="#AAA",l.fillRect(0,0,i.width,i.height),d=i.toDataURL("image/png"),o.setAttribute("src",d),e.addEventListener("canplay",function(t){s||(r=e.videoHeight/(e.videoWidth/a),isNaN(r)&&(r=150),e.setAttribute("width",a),e.setAttribute("height",r),i.setAttribute("width",a),i.setAttribute("height",r),s=!0)},!1),t.addEventListener("click",function(t){r&&(i.width=a,i.height=r,l.drawImage(e,0,0,a,r),d=i.toDataURL("image/png"),o.setAttribute("src",d),n.disabled=!1),t.preventDefault()},!1);let p=this;n.addEventListener("click",function(t){var e;t.preventDefault(),t=(e=d.split(";"))[0].split(":")[1],e=e[1].split(",")[1],t=p.b64toBlob(e,t),p._uploadImage(t)},!1)},_uploadImage:function(t){var e,i,o,n,a,r,s,d,l,c=this,p=this.get("host"),u=m.Handlebars.compile(IMAGETEMPLATE);for(p.saveSelection(),i=(e=p.get("filepickeroptions").image).savepath===undefined?"/":e.savepath,o=new FormData,n=0,a="",r=new XMLHttpRequest,s="",d=Object.keys(e.repositories),o.append("repo_upload_file",t),o.append("itemid",e.itemid),l=0;l<d.length;l++)if("upload"===e.repositories[d[l]].type){o.append("repo_id",e.repositories[d[l]].id);break}o.append("env",e.env),o.append("sesskey",M.cfg.sesskey),o.append("client_id",e.client_id),o.append("savepath",i),o.append("ctx_id",e.context.id),n=(new Date).getTime(),a="moodleimage_"+Math.round(1e5*Math.random())+"-"+n,p.focus(),p.restoreSelection(),s=u({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",COMPONENTNAME),id:a}),p.insertContentAtFocusPoint(s),c.markUpdated(),r.onreadystatechange=function(){var t,e,i=c.editor.one("#"+a);if(4===r.readyState)if(200===r.status){if(t=JSON.parse(r.responseText)){if(t.error)throw i&&i.remove(!0),new M.core.ajaxException(t);(e=t).event&&"fileexists"===t.event&&(e=t.newfile),e=u({url:e.url,presentation:!0}),e=m.Node.create(e),i?i.replace(e):c.editor.appendChild(e),c.markUpdated()}}else m.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),i&&i.remove(!0)},r.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),r.send(o)},b64toBlob:function(t,e,i){var o,n,a,r,s,d,l;for(e=e||"",i=i||512,o=atob(t),n=[],a=0;a<o.length;a+=i){for(r=o.slice(a,a+i),s=new Array(r.length),d=0;d<r.length;d++)s[d]=r.charCodeAt(d);l=new Uint8Array(s),n.push(l)}return new Blob(n,{type:e})}},{ATTRS:{}},{ATTRS:{}})},"@VERSION@");