YUI.add("moodle-atto_recittakepicture-button",function(u,e){IMAGETEMPLATE='<a href="{{url}}" target="_blank"><img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/></a>',TEMPLATE='<form id="atto_recittakepicture_dialogue" class="recittakepicture"><div class="camera"><video id="{{component}}video"></video></div><canvas id="{{component}}canvas" style="display:none"></canvas><div class="camoutput"><img id="{{component}}photo" width="{{width}}" height="{{height}}" alt="capture"></div><div class="video-controls"><div class="video-options">{{get_string "selectcamera" component}}: <select></select></div><button id="{{component}}startbutton" class="btn btn-secondary">{{get_string "takephoto" component}}</button><button class="btn btn-secondary" id="{{component}}submit" disabled> {{get_string "saveimage" component}}</button></div></form>',COMPONENTNAME="atto_recittakepicture",u.namespace("M.atto_recittakepicture").Button=u.Base.create("button",u.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,accessGranted:!0,initializer:function(){this.get("host").canShowFilepicker("media")&&(this.addButton({title:"takephoto",icon:"e/camera",iconComponent:COMPONENTNAME,callback:this.openCamera,buttonName:"takephoto"}),navigator.permissions.query({name:"camera"}).then(function(e){"prompt"==e&&(this.accessGranted=!1)}))},openCamera:function(){var e,o,t,i,n,a,d,r,s,l,c;if(!this.accessGranted)return u.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("grantaccess",COMPONENTNAME)})}),void navigator.mediaDevices.getUserMedia({video:!0});(e=this.getDialogue({headerContent:M.util.get_string("pluginname",COMPONENTNAME),width:.8*window.innerWidth,height:.8*window.innerWidth,focusAfterHide:!0})).get("boundingBox").setStyle("maxWidth","90%"),e.get("boundingBox").setStyle("maxHeight","90%"),n=u.Handlebars.compile(TEMPLATE),n=u.Node.create(n({elementid:this.get("host").get("elementid"),component:COMPONENTNAME,width:.8*window.innerWidth,height:.8*window.innerHeight})),e.set("bodyContent",n).show(),o=document.getElementById(COMPONENTNAME+"video"),t=document.getElementById(COMPONENTNAME+"canvas"),i=document.getElementById(COMPONENTNAME+"photo"),n=document.getElementById(COMPONENTNAME+"startbutton"),a=document.getElementById(COMPONENTNAME+"submit"),d=.7*window.innerWidth,r=.7*window.innerHeight,s=!1,l="",(c=t.getContext("2d")).fillStyle="#AAA",c.fillRect(0,0,t.width,t.height),l=t.toDataURL("image/png"),i.setAttribute("src",l),this.startStream({video:{facingMode:{exact:"environment"},width:{min:64,ideal:1920},height:{min:40,ideal:1080}}}),i.parentElement.style.display="none",o.addEventListener("canplay",function(e){s||(r=o.videoHeight/(o.videoWidth/d),isNaN(r)&&(r=d/(4/3)),o.videoHeight>.8*window.innerHeight&&(r=.8*window.innerHeight,d=o.videoWidth/(o.videoHeight/r)),s=!0)},!1),n.addEventListener("click",function(e){return e.preventDefault(),"none"===o.style.display?(o.style.display="block",i.parentElement.style.display="none",void(a.disabled=!0)):(o.style.display="none",i.parentElement.style.display="block",void(d&&r&&(t.width=o.videoWidth,t.height=o.videoHeight,c.drawImage(o,0,0,o.videoWidth,o.videoHeight),l=t.toDataURL("image/png"),i.setAttribute("src",l),i.removeAttribute("width"),i.removeAttribute("height"),a.disabled=!1)))},!1);let p=this;a.addEventListener("click",function(e){var t;if(e.preventDefault(),t=(i=l.split(";"))[0].split(":")[1],e=i[1].split(",")[1],"undefined"!=typeof ImageCapture){var i=o.srcObject.getVideoTracks()[0];const n=new ImageCapture(i);n.grabFrame().then(function(e){p.bmpToBlob(e,function(e){p._uploadImage(e)})})}else t=p.b64toBlob(e,t),p._uploadImage(t)},!1),this.loadCameraDevices()},loadCameraDevices:function(){let i=this;if("mediaDevices"in navigator&&navigator.mediaDevices.getUserMedia){const n=document.querySelector(".video-options>select");navigator.mediaDevices.enumerateDevices().then(function(e){const t=e.filter(e=>"videoinput"===e.kind);0==t.length&&(document.querySelector(".video-options").style.display="none");e=t.map(e=>`<option value="${e.deviceId}">${e.label}</option>`);e.push("<option value='' selected></option>"),n.innerHTML=e.join(""),n.onchange=function(){i.startStream({video:{deviceId:{exact:n.value},width:{min:64,ideal:1920},height:{min:40,ideal:1080}}})}})}else document.querySelector(".video-options").style.display="none"},startStream:function(e){var t=document.getElementById(COMPONENTNAME+"video"),i=this;e=e||{video:{width:{min:64,ideal:1920},height:{min:40,ideal:1080}}},navigator.mediaDevices.getUserMedia(e).then(function(e){t.srcObject=e,t.play()})["catch"](function(e){console.log("An error occurred: "+e),i.startStream({video:!0})})},_uploadImage:function(e){var t,i,n,o,a,d,r,s,l,c=this,p=this.get("host"),m=u.Handlebars.compile(IMAGETEMPLATE);for(p.saveSelection(),i=(t=p.get("filepickeroptions").image).savepath===undefined?"/":t.savepath,n=new FormData,o=0,a="",d=new XMLHttpRequest,r="",s=Object.keys(t.repositories),n.append("repo_upload_file",e),n.append("itemid",t.itemid),l=0;l<s.length;l++)if("upload"===t.repositories[s[l]].type){n.append("repo_id",t.repositories[s[l]].id);break}n.append("env",t.env),n.append("sesskey",M.cfg.sesskey),n.append("client_id",t.client_id),n.append("savepath",i),n.append("ctx_id",t.context.id),o=(new Date).getTime(),a="moodleimage_"+Math.round(1e5*Math.random())+"-"+o,p.focus(),p.restoreSelection(),r=m({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",COMPONENTNAME),id:a}),p.insertContentAtFocusPoint(r),c.markUpdated(),d.onreadystatechange=function(){var e,t,i=c.editor.one("#"+a);if(4===d.readyState)if(200===d.status){if(e=JSON.parse(d.responseText)){if(e.error)throw i&&i.remove(!0),new M.core.ajaxException(e);(t=e
).event&&"fileexists"===e.event&&(t=e.newfile),t=m({url:t.url,presentation:!0,classlist:"w-100"}),t=u.Node.create(t),i?i.replace(t):c.editor.appendChild(t),c.markUpdated()}}else u.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),i&&i.remove(!0)},d.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),d.send(n),c.getDialogue({focusAfterHide:null}).hide()},bmpToBlob:function(e,t){const i=document.createElement("canvas");i.width=e.width,i.height=e.height;let n=i.getContext("bitmaprenderer");n?n.transferFromImageBitmap(e):i.getContext("2d").drawImage(e,0,0);t=i.toBlob(t);return i.remove(),t},b64toBlob:function(e,t,i){var n,o,a,d,r,s,l;for(t=t||"",i=i||512,n=atob(e),o=[],a=0;a<n.length;a+=i){for(d=n.slice(a,a+i),r=new Array(d.length),s=0;s<d.length;s++)r[s]=d.charCodeAt(s);l=new Uint8Array(r),o.push(l)}return new Blob(o,{type:t})}},{ATTRS:{}},{ATTRS:{}})},"@VERSION@");